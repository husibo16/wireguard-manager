
---

# ### 一套面向生产环境的 WireGuard 一体化安装、管理与多子网路由脚本

设计一套适用于 **Debian / Ubuntu** 的 **WireGuard 一体化安装与管理脚本**。脚本必须采用 **统一的整体架构**，在同一逻辑框架下分别实现服务端与客户端功能，确保结构一致、行为可预测、维护成本低。

脚本启动后通过 **交互式菜单** 让用户选择运行角色：

* **服务端（必须有公网 IP）**
* **客户端（公司内网节点 / 员工终端）**

---

## 🔵 1. 服务端：角色明确（中心节点 + 配置管理者）

服务端必须具备公网 IP，是整个 WireGuard 网络的中心节点，负责所有配置生成、路由策略与客户端管理。

### 核心职责

* 初始化服务端环境（安装、密钥、wg 接口、基础配置）
* **统一创建客户端：自动生成密钥 / 配置文件 / 分配地址**
* 管理所有客户端（新增 / 删除 / 列表 / 配置导出）
* 控制 WireGuard 连接（启动、停止、重载、状态查询）

### 网络职责

* 启用 IPv4 / IPv6 转发
* 设置 NAT、iptables、防火墙规则
* 维护多子网（如公司内网 192.168.x.0/24）
* 实现跨子网访问：

```
员工 → VPS（服务端） → 公司内网节点 → 公司服务器
```

### 架构要求

* 服务端承担所有策略决策与配置生成
* 客户端不做密钥、不做策略、不做 NAT
* 服务端配置结构必须稳定、清晰、可扩展

---

## 🔵 2. 客户端：角色明确（执行节点 + 轻量逻辑）

客户端无需公网 IP，只负责执行服务端生成的配置。

### 客户端职责

* 安装 WireGuard
* 导入服务端生成的配置
* 执行启动 / 停止 / 状态
* 使用服务端提供的 routing 规则自动访问资源

### 特殊客户端（公司内网节点）

用于“公司内网穿透”，额外职责：

* 向服务端声明本地内网子网（如 192.168.50.0/24）
* 自动设置本地路由
* 允许外出员工通过 VPS 访问公司服务器

### 客户端架构特点

* 不生成密钥
* 不生成配置
* 不做策略决策
* 逻辑极轻，仅负责连接
* **服务端统一生成、客户端只执行** 是整体架构稳定的核心原则

---

## 🔵 3. 架构统一：结构固定 + 行为可预测

脚本必须采用统一的目录结构与模块组织方式：

```
/opt/wireguard-manager/
├── wireguard.sh                  # 主脚本（入口，交互菜单）
│
├── core/                         # 核心引擎（所有模块公用）
│   ├── core_env.sh               # 全局变量、路径、常量定义
│   ├── core_log.sh               # 日志系统（INFO/WARN/ERROR/DEBUG）
│   ├── core_system.sh            # 系统检测、依赖安装、权限检查
│   ├── core_wg.sh                # WireGuard 操作（密钥/接口/服务）
│   ├── core_net.sh               # 网络功能（NAT/转发/iptables/路由）
│   ├── core_config.sh            # 配置文件读写工具
│   └── core_utils.sh             # 工具函数（校验/UUID/文件操作）
│
├── server/                       # 服务端模块（VPS）
│   ├── server_init.sh            # 初始化服务端
│   ├── server_add_client.sh      # 添加客户端（密钥/配置/二维码 全自动）
│   ├── server_del_client.sh      # 删除客户端
│   ├── server_list.sh            # 客户端列表/状态查看
│   ├── server_export.sh          # 导出客户端配置（支持单个客户端）
│   ├── server_reload.sh          # 重载服务
│   └── server_routes.sh          # 子网 & 多网段路由管理
│
├── client/                       # 客户端模块（内网节点 & 员工设备）
│   ├── client_init.sh            # 初始化客户端环境
│   ├── client_import.sh          # 导入服务端生成的配置
│   ├── client_control.sh         # 启动/停止/状态
│   └── client_route.sh           # 内网节点专用：本地子网路由
│
├── wg-data/                      # 服务端客户端数据仓库
│   ├── server.key                # 服务端私钥
│   ├── server.pub                # 服务端公钥
│   ├── wg0.conf                  # 服务端 WireGuard 主配置
│   └── clients/
│       ├── client01/
│       │   ├── private.key
│       │   ├── public.key
│       │   ├── config.conf
│       │   ├── qrcode.png        # 安装时自动生成
│       │   └── meta.json         # 记录 IP、类型、子网等元数据
│       └── client02/
│           └── ...
│
└── logs/
    └── wireguard-manager.log     # 全量日志（DEBUG 最详细）
```

统一逻辑结构：

* 相同错误处理
* 相同日志格式
* 相同输入验证
* 模块化结构严格一致

统一交互结构：

* 安装
* 查看状态
* 管理节点
* 导出配置
* 查看日志

---

## 🔵 4. 逻辑稳定优先：可调试、可追踪、可排错

系统必须具备强健的日志与错误处理体系。

### 日志级别

* DEBUG
* INFO
* WARN
* ERROR

### 必须记录：

* 执行命令
* 命令输出 stdout/stderr
* 配置变更内容
* 关键流程节点
* 错误堆栈、返回码

### 日志格式规范

```
[YYYY-MM-DD HH:MM:SS] [LEVEL] [MODULE] message...
```

示例：

```
[2025-11-23 14:45:23] [INFO]  [server_init] 启动服务端初始化
[2025-11-23 14:45:23] [DEBUG] [core_wg] 执行命令：wg genkey
[2025-11-23 14:45:24] [ERROR] [core_net] NAT 设置失败，退出码：2
```

### 日志位置

```
/opt/wireguard-manager/logs/wireguard-manager.log
```

### Debug 模式应附加：

* 调用的命令
* 输出的 stdout / stderr
* 文件路径
* 关键变量
* 失败回滚流程

---

## 🔵 5. 模块接口定义规范（Input / Output / Side Effects）

每个模块必须使用统一规范写明自身接口。

### 模块接口统一模板

```
模块名称：
功能描述：

Input：
  - 参数
  - 环境变量
  - 依赖模块

Output：
  - 生成文件
  - 配置变更
  - 返回码

Side Effects：
  - 修改系统配置
  - 写入日志
  - 修改 wg0.conf

Error Handling：
  - 错误范围
  - 回滚策略
  - 必须记录的日志内容
```

### 示例：server_add_client.sh

```
模块名称：
  server_add_client.sh

功能描述：
  创建新的客户端节点，生成密钥、配置文件、二维码，写入服务端 wg0.conf。

Input：
  - 客户端名称
  - 客户端类型（normal / lan-node）
  - 公司内网子网（仅 lan-node）
  - 环境变量（core_env.sh）
  - 功能依赖：core_wg/core_config/core_net

Output：
  - private.key/public.key
  - config.conf
  - qrcode.png
  - meta.json
  - 更新 wg0.conf
  - 返回码（0 成功）

Side Effects：
  - 修改 wg0.conf
  - 写入 wg-data/clients/<client>/
  - 日志输出

Error Handling：
  - 密钥生成失败 → 退出，记录 ERROR
  - wg0.conf 写入失败 → 恢复备份
  - 客户端目录已存在 → 提示冲突
  - 所有异常必须写明命令与错误输出
```

---

当然可以，我帮你把 **“长期 7x24 小时运行、不能中断”** 的要求无缝整合进你的文档，让它形成一个 **专业、严肃、生产可用级别的稳定性规范**。

你可以直接复制下面这一整段，放入你的 README / 架构说明中：

---

## 🔵 6. 稳定性要求：支持长期 7×24 小时持续运行（绝不能中断）

本脚本设计目标之一，是保证 WireGuard 服务 **长期保持稳定在线**，适用于生产环境的连续运行场景（如公司内网穿透、办公 VPN、远程运维等）。

为确保 7×24 小时高可用，脚本与整体架构必须满足以下稳定性要求：

### 🔹（1）服务端 WireGuard 必须具备“持续运行不间断”的能力

* WireGuard 接口（wg0）必须在系统启动后自动运行
* 意外终止后能自动重新启动
* 不依赖人工手动启动
* 服务端的 NAT / 路由规则必须持续有效，重启不会丢失

### 🔹（2）自动健康检查（可选但强烈推荐）

脚本架构需预留扩展点，用于未来加入以下功能：

* 监听 wg 接口状态（wg show）
* 自动检查客户端握手时间（如 180 秒无握手 → 重新加载接口）
* 自动检测服务端出口网卡变化（VPS 重启后 eth0 → ens3 等变化）
* 检查 NAT/iptables 是否丢失（部分 VPS 重启容易丢规则）

### 🔹（3）启动时自动修复机制（必须）

每次运行 wireguard.sh 主脚本时，必须自动验证：

* wg0 接口是否存在
* wg0 是否处于 up 状态
* NAT 是否存在（iptables -t nat -C POSTROUTING ...）
* 系统转发（net.ipv4.ip_forward）是否为 1
* 服务端配置文件是否损坏
* 路由是否丢失（尤其是多子网）

如果检测到异常，必须自动执行修复逻辑，并写入日志。

### 🔹（4）持久化规则（不能因重启而中断）

所有网络规则必须满足 **重启后自动恢复**：

* sysctl（通过 /etc/sysctl.conf 持久化）
* NAT 规则（可写入 /etc/iptables 或使用 iptables-persistent）
* WireGuard 服务（systemd 服务 + wg-quick）
* 多子网路由（route 或 systemd-networkd）

确保任何一次重启都不会影响运行。

### 🔹（5）防崩溃设计（必须）

为了实现长期运行不中断，每个模块都必须包含：

* 明确的错误处理逻辑
* 失败后自动回滚
* 失败不会破坏已有配置
* 定位错误的详细日志

特别是：

* 添加客户端失败不能破坏 wg0.conf
* NAT 失败必须恢复原来规则
* 路由失败不能影响现有环境
* 任何脚本崩溃都不能导致服务端完全不可用

### 🔹（6）未来支持 systemd 自动重启（扩展点）

脚本架构需支持未来添加 systemd：

```
Restart=always
RestartSec=3
```

确保异常退出后自动拉起。

---

## 🔵 7. 整体目标（总结）

* 服务端与客户端角色清晰、分工明确
* 所有配置由服务端统一生成
* 客户端逻辑轻量、只负责连接
* NAT / 转发 / 路由与多子网支持完备
* 日志详细，可调试、可定位、可回滚
* 架构统一稳定，高度可扩展
**WireGuard 服务必须能够 365 天 × 24 小时持续运行，不因脚本错误、重启、网络波动而中断。**
整个脚本与所有模块都需要围绕 **“高可用、自动恢复、自愈能力”** 的原则设计。
---

## ### WireGuard 网络架构图（文字版）

```
┌──────────────────────────────────────────────────────────┐
│                        员工设备（Client）                 │
│  - 仅导入服务端生成的配置                                 │
│  - 无需公网                                               │
│  - 可访问：VPN 网段 & 公司内网（由服务端统一转发）         │
└───────────────▲────────────────────────────────────────┘
                │
                │ WireGuard 加密隧道
                │（员工 → 服务端）
                │
┌───────────────┴────────────────────────────────────────┐
│                        服务端（VPS）                    │
│  ⭐ 必须有公网 IP                                        │
│                                                          │
│  核心职责：                                               │
│  - 统一生成所有客户端的密钥与配置                        │
│  - 分配地址（10.66.x.x/24 等）                           │
│  - 管理 Peer 列表                                        │
│  - 启用 IPv4/IPv6 转发                                   │
│  - 配置 NAT / 防火墙                                     │
│  - 维护路由策略                                          │
│  - 负责跨子网转发（员工 → 服务端 → 公司内网节点）        │
│                                                          │
│  服务端是整个 WireGuard 网络的“流量中心”                │
└───────────────▲────────────────────────────────────────┘
                │
                │ WireGuard 加密隧道
                │（公司内网节点 → 服务端）
                │
┌───────────────┴────────────────────────────────────────┐
│                    公司内网节点（WG Client）            │
│  ⭐ 无需公网                                             │
│                                                          │
│  角色定位：公司内网的“出口代理节点”                      │
│                                                          │
│  客户端职责：                                             │
│  - 使用服务端生成的配置连接 WireGuard                     │
│  - 将本地公司内网子网（如 192.168.50.0/24）              │
│    告诉服务端，由服务端写入 AllowedIPs                  │
│  - 自动设置路由，让流量能从 VPN 进入本地内网              │
│                                                          │
│  这是员工访问公司内网的关键中转点                         │
└───────────────▲────────────────────────────────────────┘
                │
                │ 局域网普通网络访问（非 VPN）
                │
┌───────────────┴────────────────────────────────────────┐
│                     公司内网服务器 / 设备                │
│  例如：                                                  │
│  - 文件服务器（192.168.50.10）                           │
│  - ERP/CRM                                               │
│  - NAS                                                   │
│  - 研发/测试服务器                                       │
│                                                          │
│  员工设备最终要访问的目标资源                            │
└──────────────────────────────────────────────────────────┘
```

---


