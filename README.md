### 一套面向生产环境的 WireGuard 一体化安装、管理与多子网路由脚本
# 
设计一套适用于 Debian / Ubuntu 的 WireGuard 一体化安装与管理脚本。脚本必须采用 统一的整体架构，在同一逻辑框架下分别实现服务端与客户端功能，确保结构一致、行为可预测、维护成本低。
## 
 脚本启动后通过 交互式菜单 让用户选择运行角色：

服务端（必须有公网 IP）

客户端（公司内网节点 / 员工终端）
## 
🔵 1. 服务端：角色明确（中心节点 + 配置管理者）

服务端必须具备公网 IP，是整个 WireGuard 网络的控制中心和流量转发枢纽，负责：

核心职责

初始化服务端环境（安装、密钥、wg 接口、基础配置）

统一创建客户端：自动生成密钥 / 配置文件 / 分配地址

管理所有客户端（增删改查）

控制连接（启动、停止、重载、状态查询）

网络职责

启用 IPv4 / IPv6 转发

设置 NAT、iptables、路由

维护多子网（如公司内网 192.168.x.0/24）

实现跨子网访问：

员工 → VPS → 公司内网节点 → 公司服务器

架构要求

服务端承担所有“策略决策”与“配置生成”，保证客户端逻辑最小化

所有客户端配置必须由服务端统一管理生成

服务端配置结构必须稳定、清晰、可扩展（目录与文件格式不能混乱）
## 
🔵 2. 客户端：角色明确（执行节点 + 轻量逻辑）

客户端无需公网 IP，只负责 执行服务端提供的配置，不做策略、不做密钥、不做 NAT。

客户端职责

安装 WireGuard

导入服务端生成的配置

启动 / 停止 / 查看状态

特殊客户端（公司内网节点）

安装后会将“公司内网子网”告诉服务端

自动安装访问本地子网的路由

使外出员工可通过 VPS 访问公司服务器

客户端的架构特点

不生成密钥

不生成配置

不做策略决策

逻辑极轻，只负责连接与路由执行

服务端统一生成，客户端只执行
是脚本架构“稳定、可控、可维护”的核心原则。
## 
🔵 3. 架构统一：结构固定 + 行为可预测

脚本必须实现一套统一、稳定的结构：

统一文件结构
```
/opt/wireguard-manager/
├── wireguard.sh          # 主脚本（入口，交互菜单）
│
├── core/                         # 核心引擎（所有模块的心脏）
│   ├── core_env.sh               # 变量、路径、常量定义
│   ├── core_log.sh               # 日志系统（INFO/WARN/ERROR/DEBUG）
│   ├── core_system.sh            # 系统检测、依赖安装、权限检查
│   ├── core_wg.sh                # WireGuard 操作（密钥/接口/服务）
│   ├── core_net.sh               # 网络功能（NAT/转发/iptables/路由）
│   ├── core_config.sh            # 配置文件读写工具
│   └── core_utils.sh             # 工具函数（校验/UUID/文件操作）
│
├── server/                       # 服务端模块（VPS）
│   ├── server_init.sh            # 初始化服务端
│   ├── server_add_client.sh      # 添加客户端（密钥/配置全自动/二维码）
│   ├── server_del_client.sh      # 删除客户端
│   ├── server_list.sh            # 客户端列表/状态查看
│   ├── server_export.sh          # 导出客户端配置（支持单个客户端）
│   ├── server_reload.sh          # 重载服务
│   └── server_routes.sh          # 子网 & 多网段路由管理
│
├── client/                       # 客户端模块（内网节点 & 员工设备）
│   ├── client_init.sh            # 初始化客户端环境
│   ├── client_import.sh          # 导入服务端生成的配置
│   ├── client_control.sh         # 启动/停止/状态
│   └── client_route.sh           # 内网节点专用：设置本地子网路由
│
├── wg-data/                      # 服务端的客户端数据仓库
│   ├── server.key                # 服务端私钥
│   ├── server.pub                # 服务端公钥
│   ├── wg0.conf                  # 服务端最终配置文件
│   └── clients/                  # 存放所有客户端信息
│       ├── client01/
│       │   ├── private.key
│       │   ├── public.key
│       │   ├── config.conf       # 客户端最终配置（可导出）
│       │   ├── qrcode.png        # 添加客户端时自动生成
│       │   └── meta.json         # 客户端元信息（IP、子网等）
│       └── client02/
│           └── ...
│
└── logs/
    └── wireguard-manager.log     # 全量日志（DEBUG 模式最详细）
```

统一逻辑结构

相同的错误处理机制

相同的日志系统

相同的输入验证流程

相同的子模块调用方式

统一交互结构

无论服务端还是客户端，操作方式一致：

安装

查看状态

管理节点

导出配置

日志查看

这种“整体统一结构”确保：

逻辑不会分裂

模块可直接复用

后期扩展非常容易（加功能无需改结构）
## 
🔵 4. 逻辑稳定优先：可调试、可追踪、可排错

必须有非常详细的日志系统：

分级日志：INFO / WARN / ERROR / DEBUG

关键步骤全部记录：

执行的命令

stdout / stderr

执行结果

支持 debug 模式，全量输出内部处理过程

所有动作都有明确的失败回滚机制

开发调试、线上排查都必须依赖这些日志。
## 
🔵 5. 整体目标（简短总结）

服务端与客户端职责明确

整体架构高度统一

所有客户端配置由服务端集中管理生成

服务端负责 NAT、转发、子网路由、跨网段访问

客户端逻辑极轻，仅负责连接

日志非常详细，便于开发与调试

整套脚本结构稳定、可扩展、易维护

## 
### WireGuard 网络架构图（文字版）
```
┌──────────────────────────────────────────────────────────┐
│                        员工设备（Client）                 │
│  - 仅导入服务端生成的配置                                  │
│  - 无需公网                                               │
│  - 可访问：VPN 网段 & 公司内网（由服务端统一转发）           │
└───────────────▲────────────────────────────────────────┘
                │
                │ WireGuard 加密隧道
                │（员工 → 服务端）
                │
┌───────────────┴────────────────────────────────────────┐
│                        服务端（VPS）                    │
│  ⭐ 必须有公网 IP                                        │
│                                                          │
│  核心职责：                                               │
│  - 统一生成所有客户端的密钥与配置                        │
│  - 分配地址（10.66.x.x/24 等）                           │
│  - 管理 Peer 列表                                        │
│  - 启用 IPv4/IPv6 转发                                   │
│  - 配置 NAT / 防火墙                                     │
│  - 维护路由策略                                          │
│  - 负责跨子网转发（员工 → 服务端 → 公司内网节点）        │
│                                                          │
│  服务端是整个 WireGuard 网络的“流量中心”                │
└───────────────▲────────────────────────────────────────┘
                │
                │ WireGuard 加密隧道
                │（公司内网节点 → 服务端）
                │
┌───────────────┴────────────────────────────────────────┐
│                    公司内网节点（WG Client）            │
│  ⭐ 无需公网                                             │
│                                                          │
│  角色定位：公司内网的“出口代理节点”                      │
│                                                          │
│  客户端职责：                                             │
│  - 使用服务端生成的配置连接 WireGuard                     │
│  - 将本地公司内网子网（如 192.168.50.0/24）              │
│    告诉服务端，由服务端写入 AllowedIPs                  │
│  - 自动设置路由，让流量能从 VPN 进入本地内网              │
│                                                          │
│  这是员工访问公司内网的关键中转点                         │
└───────────────▲────────────────────────────────────────┘
                │
                │ 局域网普通网络访问（非 VPN）
                │
┌───────────────┴────────────────────────────────────────┐
│                     公司内网服务器 / 设备                │
│  例如：                                                  │
│  - 文件服务器（192.168.50.10）                           │
│  - ERP/CRM                                               │
│  - NAS                                                   │
│  - 研发/测试服务器                                       │
│                                                          │
│  员工设备最终要访问的目标资源                            │
└──────────────────────────────────────────────────────────┘
```
